{% extends "base.html" %}

{% block title %}Financial - Student Management{% endblock %}

{% block content %}
<div class="row mb-4 border-bottom border-white">
    <div class="col-md-6 p-2">
        <h1 class="text-white">Tuitions</h1>
    </div>
    <div class="col-md-6 text-end p-2">
        <a type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal">+ Add New
            Tuition</a>
    </div>
</div>


<!-- Search Form -->
<div class="card mb-4 btn-hover">
    <div class="card-body">
        <form method="POST" action="{{ url_for('tuitions.search') }}">
            <div class="row">
                <div class="col-md-2">
                    <input type="text" name="fee_id" class="form-control" placeholder="Fee ID">
                </div>
                <div class="col-md-2">
                    <input type="text" name="name" class="form-control" placeholder="Student Name">
                </div>
                <div class="col-md-2">
                    <select class="form-select" aria-label="Default select example" name="semester">
                        <option value="" selected>-- Semester --</option>
                        <option value="Spring">Spring</option>
                        <option value="Partially Paid">Summer</option>
                        <option value="Fall">Fall</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" aria-label="Default select example" name="status">
                        <option value="" selected>-- Status --</option>
                        <option value="Unpaid">Unpaid</option>
                        <option value="Partially Paid">Partially Paid</option>
                        <option value="Fully Paid">Fully Paid</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <button type="submit" class="btn btn-info w-100 btn-hover text-white">Search</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Students Table -->
<div class="table-container border border-primary rounded-4">
    <table class="table table-striped table-hover text-center">
        <thead class="table-primary sticky-header">
            <tr>
                <th>Fee Code</th>
                <th>Student</th>
                <th>Student ID</th>
                <th>Semester</th>
                <th>Academic Year</th>
                <th>Total Amount</th>
                <th>Amount Paid</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody class="table-scroll">
            {% if tuitions|length == 0 %}
            <tr>
                <td colspan="12" class="text-center text-muted">No tuition found</td>
            </tr>
            {% endif %}
            {% for tuition in tuitions %}
            <tr>
                <td>{{ tuition.fee_id }}</td>
                <td>{{ tuition.full_name }}</td>
                <td>{{ tuition.student_id }}</td>
                <td>{{ tuition.semester }}</td>
                <td>{{ tuition.academic_year }}</td>
                <td>{{ tuition.total_amount }}</td>
                <td>{{ tuition.amount_paid }}</td>
                <td>{{ tuition.payment_status }}</td>
                <td>
                    <div class="dropdown">
                        <a class="btn btn-outline-primary dropdown-toggle rounded-5" href="#" role="button"
                            data-bs-toggle="dropdown" aria-expanded="false">
                            More
                        </a>

                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item btn btn-primary"
                                    href="{{ url_for('tuitions.view', fee_id=tuition.fee_id) }}" type="button">View</a>
                            </li>
                            <li><a type="button" class="dropdown-item btn btn-primary" id="#EditModal"
                                    data-bs-toggle="modal" data-bs-target="#EditModal" data-bs-id="{{ tuition.fee_id }}"
                                    data-bs-full-name="{{ tuition.full_name }}"
                                    data-bs-academic-year="{{ tuition.academic_year }}"
                                    data-bs-total-amount="{{ tuition.total_amount }}"
                                    data-bs-amount-paid="{{ tuition.amount_paid }}">Edit</a></li>
                            <li><a class="dropdown-item text-danger" type="button"
                                    onclick="deleteTuition('{{ tuition.fee_id }}')">Delete</a></li>
                        </ul>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Add Tuition -->
<form method="POST" action="{{ url_for('tuitions.add_tuition') }}">
    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exampleModalLabel">Add New Tuition</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="form-floating mb-3">
                        <input type="number" class="form-control" id="floatingInput" placeholder="name@example.com"
                            name="student_id" required>
                        <label for="floatingInput">Student ID</label>
                    </div>
                    <div class="form-floating mb-3">
                        <select class="form-select" id="floatingSelect" aria-label="Floating label select example"
                            name="semester" required>
                            <option disabled selected>--- Select Semester ---</option>
                            <option value="Spring">Spring</option>
                            <option value="Summer">Summer</option>
                            <option value="Fall">Fall</option>
                        </select>
                        <label for="floatingSelect">Works with selects</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="number" class="form-control" id="floatingInput" placeholder="name@example.com"
                            name="academic_year" required>
                        <label for="floatingInput">Academic Year</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="number" class="form-control" id="floatingInput" placeholder="name@example.com"
                            name="total_amount" required>
                        <label for="floatingInput">Total Amount</label>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Add Tuition</button>
                </div>
            </div>
        </div>
    </div>
</form>

<!-- Edit -->
<form method="POST" action="{{ url_for('tuitions.update')}}">
    <div class="modal fade" id="EditModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exampleModalLabel">Student: <span id="modal-span-name"></span></h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="form-floating mb-3">
                        <input type="number" class="form-control" id="modal-input-id" placeholder="name@example.com"
                            name="fee_id" readonly>
                        <label for="floatingInput">Fee ID</label>
                    </div>
                    <div class="form-floating mb-3">
                        <select class="form-select" aria-label="Floating label select example" name="semester">
                            <option disabled selected>--- Select Semester ---</option>
                            <option value="Spring">Spring</option>
                            <option value="Summer">Summer</option>
                            <option value="Fall">Fall</option>
                        </select>
                        <label for="floatingSelect">Semester</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="number" class="form-control" id="modal-input-year" placeholder="name@example.com"
                            name="year" required>
                        <label for="floatingInput">Academic Year</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="number" class="form-control" id="modal-input-total" placeholder="name@example.com"
                            name="total" required>
                        <label for="floatingInput">Total Amount</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="number" class="form-control" id="modal-input-paid" placeholder="name@example.com"
                            name="paid" required>
                        <label for="floatingInput">Amount Paid</label>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Send message</button>
                    </div>
                </div>
            </div>
        </div>
</form>

<!-- Script Modal -->
<script>
    const exampleModal = document.getElementById('EditModal')
    if (exampleModal) {
        exampleModal.addEventListener('show.bs.modal', event => {
            // Button that triggered the modal
            const button = event.relatedTarget
            // Extract info from data-bs-* attributes

            const full_name = button.getAttribute('data-bs-full-name')
            const fee_id = button.getAttribute('data-bs-id')
            const year = button.getAttribute('data-bs-academic-year')
            const total = button.getAttribute('data-bs-total-amount')
            const paid = button.getAttribute('data-bs-amount-paid')
            // If necessary, you could initiate an Ajax request here
            // and then do the updating in a callback.

            // Update the modal's content.
            // Vá»›i input
            exampleModal.querySelector('#modal-span-name').textContent = full_name
            exampleModal.querySelector('#modal-input-id').value = fee_id
            exampleModal.querySelector('#modal-input-year').value = year
            exampleModal.querySelector('#modal-input-total').value = total
            exampleModal.querySelector('#modal-input-paid').value = paid


        })
    }
</script>

<!-- Script delete -->
<script>
    function deleteTuition(id) {
        if (confirm('Are you sure you want to delete this tuition?')) {
            fetch(`/tuitions/delete/${id}`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.href = '{{ url_for("tuitions.list") }}';
                    } else {
                        alert(data.message);
                    }
                });
        }
    }
</script>

{% endblock %}